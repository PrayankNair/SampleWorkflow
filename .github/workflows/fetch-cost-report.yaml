
name: Fetch Azure Cost Details

on:
  push:
    branches:
      - costmngmnt         # <-- space after '-' is required
  workflow_dispatch:       # Allows manual trigger

permissions:
  id-token: write
  contents: read

jobs:
  fetch-costs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Python dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip install "XlsxWriter>=3.2.0" pandas

          
      - name: Verify XlsxWriter version
        run: |
          python3 -c "import xlsxwriter; print('XlsxWriter version:', xlsxwriter.__version__)"


      # Azure login using OIDC
      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Update Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash

      - name: Install Cost Management Extension
        run: |
          az extension add --name costmanagement

      - name: Verify Cost Management Extension
        run: |
          az extension show --name costmanagement

      - name: Get Cost Analysis via REST
        run: |
          # Safer than inlining complex JSON with quotes; write a temp file
          cat > body.json << 'JSON'
          {
            "type": "Usage",
            "timeframe": "MonthToDate",
            "dataset": {
              "granularity": "None",
              "aggregation": {
                "totalCost": { "name": "PreTaxCost", "function": "Sum" }
              },
              "grouping": [
                { "type": "Dimension", "name": "ResourceType" }
              ]
            }
          }
          JSON

          az rest --method post \
            --uri "https://management.azure.com/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/providers/Microsoft.CostManagement/query?api-version=2023-03-01" \
            --body @body.json \
            -o json > cost-analysis.json

            
      - name: Verify XlsxWriter version
        run: |
                python3 << 'PY'
                import pandas as pd
                import xlsxwriter, sys
                print("python:", sys.version)
                print("xlsxwriter:", xlsxwriter.__version__)
                # Optional guard to fail fast if too old:
                from packaging import version
                if version.parse(xlsxwriter.__version__) < version.parse("3.2.0"):
                    raise SystemExit("XlsxWriter is too old; need >= 3.2.0")
                PY


      - name: Convert to Pivot Excel (ResourceType -> Sum of Cost, AUD)
        run: |
            import json
  
          in_path = 'cost-analysis.json'
          out_path = 'cost-analysis-pivot.xlsx'

          # 1) Load JSON
          with open(in_path, 'r', encoding='utf-8') as f:
            data = json.load(f)

          # 2) Extract rows and build DataFrame
          rows = data.get('properties', {}).get('rows', [])
          rows2 = [[r[0], r[1]] for r in rows if isinstance(r, list) and len(r) >= 2]
          df = pd.DataFrame(rows2, columns=['ResourceType', 'totalCost'])

          # 3) Clean data
          df['ResourceType'] = df['ResourceType'].fillna('(blank)')
          df['totalCost'] = pd.to_numeric(df['totalCost'], errors='coerce').fillna(0.0)

          # 4) Write raw data and create a PivotTable with XlsxWriter
          with pd.ExcelWriter(out_path, engine='xlsxwriter') as writer:
            # Write raw data to "Data" sheet
            df.to_excel(writer, sheet_name='Data', index=False)

            workbook  = writer.book
            data_ws   = writer.sheets['Data']

            # Create a new sheet for the pivot
            pivot_ws  = workbook.add_worksheet('Pivot')

            # Find the last row of the data range
            nrows = len(df) + 1  # +1 for header
            ncols = len(df.columns)

            # Define the source range, e.g., 'Data'!A1:B{n}
            # 2 columns -> A and B
            data_range = f"'Data'!A1:{chr(ord('A') + ncols - 1)}{nrows}"

            # Add the PivotTable starting at A3
            pivot_ws.add_pivot_table({
              'name':        'PivotCost',
              'source':      data_range,
              'destination': 'Pivot!A3',
              'fields': {
                'rows':   [{'name': 'ResourceType'}],
                'values': [{'name': 'totalCost', 'function': 'sum'}],
              }
            })

            # Title and formatting
            pivot_ws.write('A1', 'Cost by ResourceType (Pivot)')
            aud_fmt = workbook.add_format({'num_format': '[$-en-AU]$ #,##0.00'})
            pivot_ws.set_column('A:D', 18)
            pivot_ws.set_column('B:B', 18, aud_fmt)

          print(f"âœ… Created Excel with REAL PivotTable: {out_path}")
          PY

      - name: Upload Pivot Excel
        uses: actions/upload-artifact@v4
        with:
          name: cost-analysis-pivot
          path: cost-analysis-pivot.xlsx
