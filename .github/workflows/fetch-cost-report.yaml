
name: Fetch Azure Cost Details
on:
  push:
    branches:
      -costmngmnt
  workflow_dispatch:       # Allows manual trigger

permissions:
  id-token: write
  contents: read

jobs:
  fetch-costs:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout (optional if storing scripts)
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Azure Login using OIDC
      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Step 3: Fetch Cost Details
      - name: Get Cost Details
        run: |
          az consumption usage list \
            --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }} \
            --start-date $(date -u -d "1 day ago" '+%Y-%m-%d') \
            --end-date $(date -u '+%Y-%m-%d') \
            --query "[].{Date:usageStart, Resource:instanceName, ResourceType:instanceId, Service:meterDetails.meterName, Cost:pretaxCost}" \
 


      # Step 4: Save as Artifact
      - name: Save Cost Report
        run: |
          az consumption usage list \
            --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }} \
            --start-date $(date -u -d "1 day ago" '+%Y-%m-%d') \
            --end-date $(date -u '+%Y-%m-%d') \
            -o json > cost-report.json

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cost-report
          path: cost-report.json

      - name: Convert JSON to Excel
        run: |
          pip install pandas openpyxl
          python - <<EOF
          import pandas as pd
          import json

          with open('cost-report.json') as f:
            data = json.load(f)

          df = pd.json_normalize(data)
          df.to_excel('cost-report.xlsx', index=False)

          
      - name: Upload Excel Report
        uses: actions/upload-artifact@v3
        with:
          name: cost-report
          path: cost-report.xlsx
