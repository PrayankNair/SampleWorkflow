
name: Fetch Azure Cost Details
on:
  schedule:
    - cron: '0 6 * * *'   # Runs daily at 6 AM UTC
  workflow_dispatch:       # Allows manual trigger

permissions:
  id-token: write
  contents: read

jobs:
  fetch-costs:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout (optional if storing scripts)
      - name: Checkout code
        uses: actions/checkout@v3

      # Step 2: Azure Login using OIDC
      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      # Step 3: Fetch Cost Details
      - name: Get Cost Details
        run: |
          az consumption usage list \
              --subscription <your-subscription-id> \
              --start-date $(date -u -d "1 day ago" '+%Y-%m-%d') \
              --end-date $(date -u '+%Y-%m-%d') \
              --query "[].{Date:usageStart, Resource:instanceName, ResourceType:instanceId, Service:meterDetails.meterName, Cost:pretaxCost}" \
 


      # Step 4: Save as Artifact
      - name: Save Cost Report
        run: |
          az consumption usage list \
            --subscription ${{ secrets.AZURE_SUBSCRIPTION_ID }} \
            --start-date $(date -u -d "1 day ago" '+%Y-%m-%d') \
            --end-date $(date -u '+%Y-%m-%d') \
            -o json > cost-report.json

      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: cost-report
          path: cost-report.json
